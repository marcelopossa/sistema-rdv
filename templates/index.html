<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema RDV - Relat√≥rio de Despesas de Viagem</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; font-weight: 300; }
        .nav-tabs {
            display: flex;
            background: #34495e;
            border-bottom: 3px solid #2c3e50;
        }
        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            color: #ecf0f1;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        .nav-tab.active {
            background: #3498db;
            border-bottom-color: #e74c3c;
        }
        .nav-tab:hover:not(.active) { background: #4a6741; }
        .tab-content { display: none; padding: 40px; }
        .tab-content.active { display: block; }
        .form-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border-left: 5px solid #3498db;
        }
        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-group { display: flex; flex-direction: column; }
        label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        input, select, textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        .btn-secondary { background: linear-gradient(135deg, #95a5a6, #7f8c8d); }
        .btn-success { background: linear-gradient(135deg, #27ae60, #219a52); }
        .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .btn-small { padding: 8px 15px; font-size: 0.8em; }
        .clientes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .cliente-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #3498db;
            transition: all 0.3s ease;
        }
        .cliente-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .cliente-nome {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
        }
        .cliente-info {
            color: #7f8c8d;
            margin-bottom: 10px;
        }
        .cliente-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }
        .file-upload input[type=file] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
        }
        .file-upload-label {
            display: block;
            padding: 12px;
            background: #ecf0f1;
            border: 2px dashed #bdc3c7;
            border-radius: 8px;
            text-align: center;
            transition: all 0.3s ease;
        }
        .file-upload:hover .file-upload-label {
            background: #d5dbdb;
            border-color: #95a5a6;
        }
        .results-section {
            background: #e8f5e8;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            border-left: 5px solid #27ae60;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .summary-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .summary-item h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .summary-item .value {
            font-size: 1.8em;
            font-weight: bold;
            color: #27ae60;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover { color: #000; }
        .historico-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .historico-table th, .historico-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .historico-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .historico-table tr:hover { background-color: #f5f5f5; }
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 5px solid;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border-color: #27ae60;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-color: #e74c3c;
        }
        .alert-info {
            background: #cce8f4;
            color: #0c5460;
            border-color: #3498db;
        }
        .km-info {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9em;
        }
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .nav-tabs { flex-direction: column; }
            .clientes-grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 1.8em; }
            .content { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöó Sistema RDV</h1>
            <p>Automatiza√ß√£o de Relat√≥rio de Despesas de Viagem</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('novo-rdv')">üìã Novo RDV</button>
            <button class="nav-tab" onclick="showTab('clientes')">üè¢ Clientes</button>
            <button class="nav-tab" onclick="showTab('historico')">ÔøΩÔøΩ Hist√≥rico</button>
        </div>

        <!-- Aba Novo RDV -->
        <div id="novo-rdv" class="tab-content active">
            <div class="form-section">
                <h3>üè¢ Sele√ß√£o de Cliente</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="clienteSelect">Cliente</label>
                        <select id="clienteSelect" onchange="selecionarCliente()">
                            <option value="">Selecione um cliente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="valorKmDisplay">Valor por KM</label>
                        <input type="text" id="valorKmDisplay" readonly style="background: #f8f9fa;">
                    </div>
                    <div class="form-group">
                        <label for="kmPadraoDisplay">KM Padr√£o do Cliente</label>
                        <input type="text" id="kmPadraoDisplay" readonly style="background: #f8f9fa;">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="observacoesCliente">Observa√ß√µes do Cliente</label>
                        <input type="text" id="observacoesCliente" readonly style="background: #f8f9fa;">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>üìã Informa√ß√µes B√°sicas da Viagem</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="dataViagem">Data da Viagem</label>
                        <input type="date" id="dataViagem" required>
                    </div>
                    <div class="form-group">
                        <label for="projeto">Projeto (opcional)</label>
                        <input type="text" id="projeto" placeholder="C√≥digo ou nome do projeto">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="participantes">Participantes</label>
                        <input type="text" id="participantes" placeholder="Ex: MARCELO / AGOSTINHO" required>
                    </div>
                    <div class="form-group">
                        <label for="beneficiario">Benefici√°rio</label>
                        <input type="text" id="beneficiario" value="MARCELO POSSA" readonly>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>üõ£Ô∏è Quilometragem</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="kmRodado">Quil√¥metros Rodados</label>
                        <input type="number" id="kmRodado" placeholder="226" required>
                        <div class="km-info" id="kmInfo" style="display: none;">
                            üí° Sugest√£o baseada no hist√≥rico do cliente
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="valorKm">Valor por KM (R$)</label>
                        <input type="number" id="valorKm" step="0.01" readonly style="background: #f8f9fa;">
                    </div>
                    <div class="form-group">
                        <label>Total KM</label>
                        <input type="text" id="totalKm" readonly style="background: #f8f9fa;">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>üìÑ Upload de Documentos</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Relat√≥rio de Ped√°gios (PDF)</label>
                        <div class="file-upload">
                            <input type="file" id="pedagioFile" accept=".pdf" multiple>
                            <label for="pedagioFile" class="file-upload-label">
                                üìÅ Selecionar Extrato Unificado
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notas Fiscais de Alimenta√ß√£o (PDF)</label>
                        <div class="file-upload">
                            <input type="file" id="alimentacaoFiles" accept=".pdf" multiple>
                            <label for="alimentacaoFiles" class="file-upload-label">
                                üçΩÔ∏è Selecionar NFC-e
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Comprovantes de Hospedagem (PDF)</label>
                        <div class="file-upload">
                            <input type="file" id="hospedagemFiles" accept=".pdf" multiple>
                            <label for="hospedagemFiles" class="file-upload-label">
                                üè® Selecionar Comprovantes
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>üí∞ Valores (preenchimento autom√°tico ap√≥s upload)</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="valorPedagio">Total Ped√°gio (R$)</label>
                        <input type="number" id="valorPedagio" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="valorAlimentacao">Total Alimenta√ß√£o (R$)</label>
                        <input type="number" id="valorAlimentacao" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="valorHospedagem">Total Hospedagem (R$)</label>
                        <input type="number" id="valorHospedagem" step="0.01" placeholder="0.00">
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin: 30px 0;">
                <button class="btn" onclick="processarDocumentos()">
                    üîÑ Processar Documentos
                </button>
                <button class="btn btn-success" onclick="gerarRelatorio()" style="margin-left: 20px;">
                    üìä Gerar Relat√≥rio
                </button>
            </div>

            <div id="resultados" class="results-section" style="display: none;">
                <h3>üìà Resumo Financeiro</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <h4>Quilometragem</h4>
                        <div class="value" id="resumoKm">R$ 0,00</div>
                    </div>
                    <div class="summary-item">
                        <h4>Ped√°gio</h4>
                        <div class="value" id="resumoPedagio">R$ 0,00</div>
                    </div>
                    <div class="summary-item">
                        <h4>Alimenta√ß√£o</h4>
                        <div class="value" id="resumoAlimentacao">R$ 0,00</div>
                    </div>
                    <div class="summary-item">
                        <h4>Hospedagem</h4>
                        <div class="value" id="resumoHospedagem">R$ 0,00</div>
                    </div>
                    <div class="summary-item" style="grid-column: 1 / -1; background: #e74c3c; color: white;">
                        <h4>Total Geral</h4>
                        <div class="value" id="resumoTotal" style="color: white;">R$ 0,00</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-success" onclick="baixarExcel()">
                        üì• Baixar Planilha Excel
                    </button>
                    <button class="btn btn-secondary" onclick="baixarPDF()" style="margin-left: 20px;">
                        üìÑ Baixar PDF Completo
                    </button>
                </div>
            </div>
        </div>

        <!-- Aba Clientes -->
        <div id="clientes" class="tab-content">
            <div class="form-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>üè¢ Gest√£o de Clientes</h3>
                    <button class="btn" onclick="abrirModalCliente()">
                        ‚ûï Novo Cliente
                    </button>
                </div>
                <div id="clientesLista" class="clientes-grid">
                </div>
            </div>
        </div>

        <!-- Aba Hist√≥rico -->
        <div id="historico" class="tab-content">
            <div class="form-section">
                <h3>üìä Hist√≥rico de Viagens</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="filtroCliente">Filtrar por Cliente</label>
                        <select id="filtroCliente">
                            <option value="">Todos os clientes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filtroData">Filtrar por Per√≠odo</label>
                        <input type="month" id="filtroData">
                    </div>
                </div>
                <table class="historico-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Cliente</th>
                            <th>Projeto</th>
                            <th>KM</th>
                            <th>Total</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="historicoLista">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para Cadastro/Edi√ß√£o de Cliente -->
    <div id="modalCliente" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModalCliente()">&times;</span>
            <h2 id="modalTitulo">Novo Cliente</h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="nomeCliente">Nome do Cliente *</label>
                    <input type="text" id="nomeCliente" required>
                </div>
                <div class="form-group">
                    <label for="valorKmCliente">Valor por KM (R$) *</label>
                    <input type="number" id="valorKmCliente" step="0.01" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="kmPadraoCliente">Quil√¥metros Padr√£o</label>
                    <input type="number" id="kmPadraoCliente" placeholder="Ex: 226">
                    <small style="color: #666;">Dist√¢ncia usual para este cliente</small>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="contatoCliente">Contato</label>
                    <input type="text" id="contatoCliente" placeholder="Email ou telefone">
                </div>
                <div class="form-group">
                    <label for="enderecoCliente">Endere√ßo</label>
                    <input type="text" id="enderecoCliente">
                </div>
            </div>
            
            <div class="form-group">
                <label for="observacoesClienteModal">Observa√ß√µes</label>
                <textarea id="observacoesClienteModal" rows="3" placeholder="Observa√ß√µes sobre valores, condi√ß√µes especiais, etc."></textarea>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-success" onclick="salvarCliente()">
                    üíæ Salvar Cliente
                </button>
                <button class="btn btn-secondary" onclick="fecharModalCliente()" style="margin-left: 20px;">
                    ‚ùå Cancelar
                </button>
            </div>
        </div>
    </div>

    <script>
        let clientes = [];
        let historico = [];
        let clienteEditando = null;

        document.addEventListener('DOMContentLoaded', function() {
            carregarClientes();
            carregarHistorico();
            
            document.getElementById('kmRodado').addEventListener('input', calcularTotalKm);
            document.getElementById('valorKm').addEventListener('input', calcularTotalKm);
            
            ['valorPedagio', 'valorAlimentacao', 'valorHospedagem'].forEach(id => {
                document.getElementById(id).addEventListener('input', atualizarResumo);
            });
        });

        function showTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const container = document.querySelector('.tab-content.active');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => alertDiv.remove(), 5000);
        }

        async function carregarClientes() {
            try {
                const response = await fetch('/api/clientes');
                const data = await response.json();
                
                clientes = data;
                
                const select = document.getElementById('clienteSelect');
                const filtro = document.getElementById('filtroCliente');
                
                select.innerHTML = '<option value="">Selecione um cliente</option>';
                filtro.innerHTML = '<option value="">Todos os clientes</option>';
                
                clientes.forEach(cliente => {
                    const option = new Option(cliente.nome, cliente.id);
                    select.add(option.cloneNode(true));
                    filtro.add(option);
                });
                
                carregarCardsClientes();
                
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
                showAlert('Erro ao carregar clientes', 'error');
            }
        }

        function carregarCardsClientes() {
            const lista = document.getElementById('clientesLista');
            lista.innerHTML = '';
            
            clientes.forEach(cliente => {
                const card = document.createElement('div');
                card.className = 'cliente-card';
                card.innerHTML = `
                    <div class="cliente-nome">${cliente.nome}</div>
                    <div class="cliente-info">üí∞ Valor/KM: R$ ${cliente.valor_km.toFixed(2).replace('.', ',')}</div>
                    <div class="cliente-info">üõ£Ô∏è KM Padr√£o: ${cliente.km_padrao} km</div>
                    <div class="cliente-info">üìß ${cliente.contato}</div>
                    <div class="cliente-info">üìç ${cliente.endereco}</div>
                    <div class="cliente-info">üìù ${cliente.observacoes}</div>
                    <div class="cliente-actions">
                        <button class="btn btn-small" onclick="editarCliente(${cliente.id})">‚úèÔ∏è Editar</button>
                        <button class="btn btn-danger btn-small" onclick="excluirCliente(${cliente.id})">üóëÔ∏è Excluir</button>
                    </div>
                `;
                lista.appendChild(card);
            });
        }

        function selecionarCliente() {
            const clienteId = document.getElementById('clienteSelect').value;
            
            if (clienteId) {
                const cliente = clientes.find(c => c.id == clienteId);
                if (cliente) {
                    document.getElementById('valorKm').value = cliente.valor_km;
                    document.getElementById('valorKmDisplay').value = `R$ ${cliente.valor_km.toFixed(2).replace('.', ',')}`;
                    document.getElementById('kmPadraoDisplay').value = `${cliente.km_padrao} km`;
                    document.getElementById('observacoesCliente').value = cliente.observacoes;
                    
                    // Sugerir KM padr√£o
                    if (cliente.km_padrao > 0) {
                        document.getElementById('kmRodado').value = cliente.km_padrao;
                        document.getElementById('kmInfo').style.display = 'block';
                        document.getElementById('kmInfo').textContent = `üí° Sugest√£o: ${cliente.km_padrao} km (padr√£o para ${cliente.nome})`;
                    }
                    
                    calcularTotalKm();
                }
            } else {
                document.getElementById('valorKm').value = '';
                document.getElementById('valorKmDisplay').value = '';
                document.getElementById('kmPadraoDisplay').value = '';
                document.getElementById('observacoesCliente').value = '';
                document.getElementById('kmRodado').value = '';
                document.getElementById('kmInfo').style.display = 'none';
                document.getElementById('totalKm').value = '';
            }
        }

        async function salvarCliente() {
            const nome = document.getElementById('nomeCliente').value;
            const valorKm = parseFloat(document.getElementById('valorKmCliente').value);
            const kmPadrao = parseFloat(document.getElementById('kmPadraoCliente').value) || 0;
            const contato = document.getElementById('contatoCliente').value;
            const endereco = document.getElementById('enderecoCliente').value;
            const observacoes = document.getElementById('observacoesClienteModal').value;
            
            if (!nome || !valorKm) {
                showAlert('Por favor, preencha os campos obrigat√≥rios.', 'error');
                return;
            }
            
            const clienteData = {
                nome,
                valor_km: valorKm,
                km_padrao: kmPadrao,
                contato,
                endereco,
                observacoes
            };
            
            try {
                let response;
                if (clienteEditando) {
                    response = await fetch(`/api/clientes/${clienteEditando}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(clienteData)
                    });
                } else {
                    response = await fetch('/api/clientes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(clienteData)
                    });
                }
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert(result.message, 'success');
                    carregarClientes();
                    fecharModalCliente();
                } else {
                    showAlert(result.error, 'error');
                }
                
            } catch (error) {
                console.error('Erro ao salvar cliente:', error);
                showAlert('Erro ao salvar cliente', 'error');
            }
        }

        async function excluirCliente(clienteId) {
            if (confirm('Tem certeza que deseja excluir este cliente?')) {
                try {
                    const response = await fetch(`/api/clientes/${clienteId}`, { method: 'DELETE' });
                    const result = await response.json();
                    
                    if (response.ok) {
                        showAlert(result.message, 'success');
                        carregarClientes();
                    } else {
                        showAlert(result.error, 'error');
                    }
                } catch (error) {
                    console.error('Erro ao excluir cliente:', error);
                    showAlert('Erro ao excluir cliente', 'error');
                }
            }
        }

        function abrirModalCliente(clienteId = null) {
            const modal = document.getElementById('modalCliente');
            const titulo = document.getElementById('modalTitulo');
            
            if (clienteId) {
                const cliente = clientes.find(c => c.id == clienteId);
                titulo.textContent = 'Editar Cliente';
                document.getElementById('nomeCliente').value = cliente.nome;
                document.getElementById('valorKmCliente').value = cliente.valor_km;
                document.getElementById('kmPadraoCliente').value = cliente.km_padrao;
                document.getElementById('contatoCliente').value = cliente.contato;
                document.getElementById('enderecoCliente').value = cliente.endereco;
                document.getElementById('observacoesClienteModal').value = cliente.observacoes;
                clienteEditando = clienteId;
            } else {
                titulo.textContent = 'Novo Cliente';
                document.getElementById('nomeCliente').value = '';
                document.getElementById('valorKmCliente').value = '';
                document.getElementById('kmPadraoCliente').value = '';
                document.getElementById('contatoCliente').value = '';
                document.getElementById('enderecoCliente').value = '';
                document.getElementById('observacoesClienteModal').value = '';
                clienteEditando = null;
            }
            
            modal.style.display = 'block';
        }

        function fecharModalCliente() {
            document.getElementById('modalCliente').style.display = 'none';
        }

        function editarCliente(clienteId) {
            abrirModalCliente(clienteId);
        }

        function calcularTotalKm() {
            const km = parseFloat(document.getElementById('kmRodado').value) || 0;
            const valorKm = parseFloat(document.getElementById('valorKm').value) || 0;
            const total = km * valorKm;
            document.getElementById('totalKm').value = `R$ ${total.toFixed(2).replace('.', ',')}`;
        }

        function atualizarResumo() {
            const km = parseFloat(document.getElementById('kmRodado').value) || 0;
            const valorKm = parseFloat(document.getElementById('valorKm').value) || 0;
            const totalKm = km * valorKm;
            
            const pedagio = parseFloat(document.getElementById('valorPedagio').value) || 0;
            const alimentacao = parseFloat(document.getElementById('valorAlimentacao').value) || 0;
            const hospedagem = parseFloat(document.getElementById('valorHospedagem').value) || 0;
            
            const total = totalKm + pedagio + alimentacao + hospedagem;

            document.getElementById('resumoKm').textContent = `R$ ${totalKm.toFixed(2).replace('.', ',')}`;
            document.getElementById('resumoPedagio').textContent = `R$ ${pedagio.toFixed(2).replace('.', ',')}`;
            document.getElementById('resumoAlimentacao').textContent = `R$ ${alimentacao.toFixed(2).replace('.', ',')}`;
            document.getElementById('resumoHospedagem').textContent = `R$ ${hospedagem.toFixed(2).replace('.', ',')}`;
            document.getElementById('resumoTotal').textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
        }

        async function processarDocumentos() {
    console.log('üöÄ Iniciando processamento...');
    
    const pedagioFiles = document.getElementById('pedagioFile').files;
    const alimentacaoFiles = document.getElementById('alimentacaoFiles').files;
    const hospedagemFiles = document.getElementById('hospedagemFiles').files;

    console.log('üìÅ Arquivos encontrados:');
    console.log('- Ped√°gio:', pedagioFiles.length);
    console.log('- Alimenta√ß√£o:', alimentacaoFiles.length);
    console.log('- Hospedagem:', hospedagemFiles.length);

    if (pedagioFiles.length === 0 && alimentacaoFiles.length === 0 && hospedagemFiles.length === 0) {
        showAlert('Por favor, selecione pelo menos um documento para processar.', 'error');
        return;
    }

    // Criar FormData corretamente
    const formData = new FormData();
    
    // Adicionar arquivos com nomes corretos
    Array.from(pedagioFiles).forEach(file => {
        formData.append('pedagioFile', file);
        console.log('‚úÖ Adicionado ped√°gio:', file.name);
    });
    
    Array.from(alimentacaoFiles).forEach(file => {
        formData.append('alimentacaoFiles', file);
        console.log('‚úÖ Adicionado alimenta√ß√£o:', file.name);
    });
    
    Array.from(hospedagemFiles).forEach(file => {
        formData.append('hospedagemFiles', file);
        console.log('‚úÖ Adicionado hospedagem:', file.name);
    });

    try {
        console.log('üì° Enviando para servidor...');
        
        const response = await fetch('/api/processar-documentos', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        console.log('üìä Resposta:', result);
        
        if (response.ok) {
            document.getElementById('valorPedagio').value = result.pedagio.toFixed(2);
            document.getElementById('valorAlimentacao').value = result.alimentacao.toFixed(2);
            document.getElementById('valorHospedagem').value = result.hospedagem.toFixed(2);
            
            showAlert('‚úÖ Documentos processados com sucesso!', 'success');
            atualizarResumo();
        } else {
            showAlert(`Erro: ${result.error}`, 'error');
        }
    } catch (error) {
        console.error('‚ùå Erro:', error);
        showAlert('Erro ao processar documentos: ' + error.message, 'error');
    }
}

        async function gerarRelatorio() {
            const clienteId = document.getElementById('clienteSelect').value;
            const data = document.getElementById('dataViagem').value;
            const participantes = document.getElementById('participantes').value;
            const km = document.getElementById('kmRodado').value;

            if (!clienteId || !data || !participantes || !km) {
                showAlert('Por favor, preencha todos os campos obrigat√≥rios.', 'error');
                return;
            }

            const viagemData = {
                cliente_id: clienteId,
                data_viagem: data,
                projeto: document.getElementById('projeto').value,
                participantes: participantes,
                km_rodado: parseFloat(km),
                valor_km: parseFloat(document.getElementById('valorKm').value),
                valor_pedagio: parseFloat(document.getElementById('valorPedagio').value) || 0,
                valor_alimentacao: parseFloat(document.getElementById('valorAlimentacao').value) || 0,
                valor_hospedagem: parseFloat(document.getElementById('valorHospedagem').value) || 0
            };

            try {
                const response = await fetch('/api/viagens', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(viagemData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert(result.message, 'success');
                    atualizarResumo();
                    carregarHistorico();
                    
                    document.getElementById('resultados').style.display = 'block';
                    document.getElementById('resultados').scrollIntoView({ behavior: 'smooth' });
                } else {
                    showAlert(result.error, 'error');
                }
            } catch (error) {
                console.error('Erro ao criar viagem:', error);
                showAlert('Erro ao gerar relat√≥rio', 'error');
            }
        }

        async function carregarHistorico() {
            try {
                const response = await fetch('/api/viagens');
                const data = await response.json();
                
                historico = data;
                
                const tbody = document.getElementById('historicoLista');
                tbody.innerHTML = '';
                
                historico.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${new Date(item.data_viagem).toLocaleDateString('pt-BR')}</td>
                        <td>${item.cliente_nome}</td>
                        <td>${item.projeto}</td>
                        <td>${item.km_rodado} km</td>
                        <td>R$ ${item.total_geral.toFixed(2).replace('.', ',')}</td>
                        <td>
                            <button class="btn btn-small" onclick="visualizarRDV(${item.id})">üëÅÔ∏è Ver</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Erro ao carregar hist√≥rico:', error);
                showAlert('Erro ao carregar hist√≥rico', 'error');
            }
        }

        function visualizarRDV(id) {
            showAlert(`Funcionalidade em desenvolvimento: Visualizar/Reemitir RDV #${id}`, 'info');
        }

        function baixarExcel() {
    const resultados = document.getElementById('resultados');
    if (resultados.style.display === 'none') {
        showAlert('Por favor, gere um relat√≥rio primeiro antes de baixar Excel.', 'error');
        return;
    }
    
    // Buscar √∫ltima viagem criada (pode ser melhorado para usar ID espec√≠fico)
    showAlert('üì• Gerando planilha Excel...', 'info');
    
    // Simular gera√ß√£o e download
    fetch('/api/viagens')
        .then(response => response.json())
        .then(viagens => {
            if (viagens.length > 0) {
                const ultimaViagem = viagens[0];
                const url = `/api/gerar-excel/${ultimaViagem.id}`;
                
                // Criar link de download
                const link = document.createElement('a');
                link.href = url;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showAlert('‚úÖ Excel gerado com sucesso!', 'success');
            } else {
                showAlert('Erro: Nenhuma viagem encontrada', 'error');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            showAlert('Erro ao gerar Excel: ' + error.message, 'error');
        });
}
    
        // Fun√ß√£o baixarPDF - ADICIONADA AUTOMATICAMENTE
        async function baixarPDF() {
            try {
                console.log('üìÑ baixarPDF() chamada');
                showAlert('Gerando PDF...', 'info');
                
                // Buscar a √∫ltima viagem processada
                const viagensResponse = await fetch('/api/viagens');
                const viagens = await viagensResponse.json();
                
                if (!viagens || viagens.length === 0) {
                    throw new Error('Nenhuma viagem encontrada. Processe documentos primeiro.');
                }
                
                // Usar a √∫ltima viagem (mais recente)
                const ultimaViagem = viagens[viagens.length - 1];
                const viagemId = ultimaViagem.id;
                
                console.log('üéØ Gerando PDF para viagem ID:', viagemId);
                
                // Chamar API para gerar PDF
                const response = await fetch(`/api/gerar-pdf/${viagemId}`);
                console.log('üì° Response status:', response.status);
                
                if (response.ok) {
                    const blob = await response.blob();
                    console.log('üìÑ PDF recebido, tamanho:', blob.size, 'bytes');
                    
                    // Download do arquivo
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `RDV_Viagem_${viagemId}_${new Date().toISOString().slice(0,10)}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showAlert('PDF baixado com sucesso!', 'success');
                    console.log('‚úÖ Download conclu√≠do');
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Erro do servidor:', errorText);
                    throw new Error(`Erro ${response.status}: ${errorText}`);
                }
            } catch (error) {
                console.error('‚ùå Erro detalhado:', error);
                showAlert('Erro ao baixar PDF: ' + error.message, 'error');
            }
        }

    </script>
</body>
</html>
